#!/bin/bash

# Script d'installation pour le workflow Ultravox n8n
# Auteur: Assistant Scout
# Date: 18 janvier 2025
# Version: 1.0

set -e

# Couleurs pour les messages
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Variables
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
WORKFLOW_NAME="ultravox-workflow"
DB_NAME="ultravox_db"
DB_USER="ultravox_user"

# Fonctions utilitaires
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

check_command() {
    if ! command -v "$1" &> /dev/null; then
        log_error "La commande '$1' n'est pas installÃ©e."
        return 1
    fi
    return 0
}

# Banner d'installation
echo -e "${BLUE}"
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘           Installation Workflow Ultravox n8n              â•‘"
echo "â•‘                      Version 1.0                          â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo -e "${NC}"

# VÃ©rification des prÃ©requis
log_info "VÃ©rification des prÃ©requis..."

# VÃ©rifier si Docker est installÃ©
if check_command "docker"; then
    log_success "Docker est installÃ©"
else
    log_error "Docker est requis. Veuillez l'installer d'abord."
    exit 1
fi

# VÃ©rifier si Docker Compose est installÃ©
if check_command "docker-compose"; then
    log_success "Docker Compose est installÃ©"
else
    log_error "Docker Compose est requis. Veuillez l'installer d'abord."
    exit 1
fi

# VÃ©rifier si curl est installÃ©
if check_command "curl"; then
    log_success "curl est installÃ©"
else
    log_error "curl est requis. Veuillez l'installer d'abord."
    exit 1
fi

# CrÃ©er le rÃ©pertoire de travail
log_info "CrÃ©ation du rÃ©pertoire de travail..."
WORK_DIR="$HOME/${WORKFLOW_NAME}"
mkdir -p "$WORK_DIR"
cd "$WORK_DIR"

# Copier les fichiers du workflow
log_info "Copie des fichiers du workflow..."
cp "$SCRIPT_DIR/workflow-ultravox-n8n.json" "$WORK_DIR/"
cp "$SCRIPT_DIR/instructions-workflow-ultravox.md" "$WORK_DIR/"
cp "$SCRIPT_DIR/config-exemple.env" "$WORK_DIR/.env.example"

# CrÃ©er le fichier docker-compose.yml
log_info "CrÃ©ation du fichier docker-compose.yml..."
cat > docker-compose.yml << 'EOF'
version: '3.8'

services:
  n8n:
    image: n8nio/n8n:latest
    container_name: n8n-ultravox
    restart: always
    ports:
      - "5678:5678"
    environment:
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=admin
      - N8N_BASIC_AUTH_PASSWORD=changeme123
      - N8N_HOST=localhost
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - NODE_ENV=production
      - WEBHOOK_URL=http://localhost:5678/
      - GENERIC_TIMEZONE=Europe/Paris
    volumes:
      - n8n_data:/home/node/.n8n
      - ./workflows:/opt/workflows
    depends_on:
      - postgres
    networks:
      - ultravox-network

  postgres:
    image: postgres:15-alpine
    container_name: postgres-ultravox
    restart: always
    environment:
      - POSTGRES_DB=ultravox_db
      - POSTGRES_USER=ultravox_user
      - POSTGRES_PASSWORD=ultravox_password_123
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5432:5432"
    networks:
      - ultravox-network

  redis:
    image: redis:7-alpine
    container_name: redis-ultravox
    restart: always
    volumes:
      - redis_data:/data
    networks:
      - ultravox-network

volumes:
  n8n_data:
  postgres_data:
  redis_data:

networks:
  ultravox-network:
    driver: bridge
EOF

# CrÃ©er le script d'initialisation de la base de donnÃ©es
log_info "CrÃ©ation du script d'initialisation PostgreSQL..."
cat > init.sql << 'EOF'
-- CrÃ©ation de la table pour les statistiques Ultravox
CREATE TABLE IF NOT EXISTS ultravox_stats (
    id SERIAL PRIMARY KEY,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    total_calls INTEGER NOT NULL DEFAULT 0,
    total_duration VARCHAR(50) NOT NULL DEFAULT '0s',
    joined_calls INTEGER NOT NULL DEFAULT 0,
    daily_data JSONB,
    metadata JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Index pour optimiser les requÃªtes
CREATE INDEX IF NOT EXISTS idx_ultravox_stats_timestamp ON ultravox_stats(timestamp);
CREATE INDEX IF NOT EXISTS idx_ultravox_stats_date ON ultravox_stats(DATE(timestamp));
CREATE INDEX IF NOT EXISTS idx_ultravox_stats_daily_data ON ultravox_stats USING GIN(daily_data);

-- CrÃ©ation de la table pour les transcripts
CREATE TABLE IF NOT EXISTS ultravox_transcripts (
    id SERIAL PRIMARY KEY,
    call_id VARCHAR(255) UNIQUE NOT NULL,
    messages JSONB NOT NULL,
    rdv_detected BOOLEAN DEFAULT FALSE,
    rdv_details JSONB,
    processed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Index pour les transcripts
CREATE INDEX IF NOT EXISTS idx_ultravox_transcripts_call_id ON ultravox_transcripts(call_id);
CREATE INDEX IF NOT EXISTS idx_ultravox_transcripts_rdv ON ultravox_transcripts(rdv_detected);
CREATE INDEX IF NOT EXISTS idx_ultravox_transcripts_processed ON ultravox_transcripts(processed_at);

-- CrÃ©ation de la table pour les rendez-vous confirmÃ©s
CREATE TABLE IF NOT EXISTS confirmed_appointments (
    id SERIAL PRIMARY KEY,
    call_id VARCHAR(255) NOT NULL,
    title VARCHAR(500) NOT NULL,
    description TEXT,
    start_date TIMESTAMP NOT NULL,
    end_date TIMESTAMP NOT NULL,
    location VARCHAR(500),
    participant_email VARCHAR(255),
    participant_phone VARCHAR(50),
    calendar_event_id VARCHAR(255),
    confirmation_sent BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Index pour les rendez-vous
CREATE INDEX IF NOT EXISTS idx_confirmed_appointments_call_id ON confirmed_appointments(call_id);
CREATE INDEX IF NOT EXISTS idx_confirmed_appointments_start_date ON confirmed_appointments(start_date);
CREATE INDEX IF NOT EXISTS idx_confirmed_appointments_participant ON confirmed_appointments(participant_email, participant_phone);

-- CrÃ©ation d'une vue pour les statistiques quotidiennes
CREATE OR REPLACE VIEW daily_stats AS
SELECT 
    DATE(timestamp) as date,
    SUM(total_calls) as total_calls,
    SUM(joined_calls) as joined_calls,
    AVG(total_calls) as avg_calls_per_execution,
    COUNT(*) as executions_count
FROM ultravox_stats 
GROUP BY DATE(timestamp)
ORDER BY date DESC;

-- CrÃ©ation d'une vue pour les tendances RDV
CREATE OR REPLACE VIEW rdv_trends AS
SELECT 
    DATE(processed_at) as date,
    COUNT(*) as total_calls_processed,
    SUM(CASE WHEN rdv_detected THEN 1 ELSE 0 END) as rdv_detected_count,
    ROUND(
        (SUM(CASE WHEN rdv_detected THEN 1 ELSE 0 END)::DECIMAL / COUNT(*)) * 100, 
        2
    ) as rdv_detection_rate
FROM ultravox_transcripts
GROUP BY DATE(processed_at)
ORDER BY date DESC;

-- Fonction pour nettoyer les anciennes donnÃ©es
CREATE OR REPLACE FUNCTION cleanup_old_data()
RETURNS VOID AS $$
BEGIN
    -- Supprimer les statistiques de plus de 1 an
    DELETE FROM ultravox_stats 
    WHERE timestamp < NOW() - INTERVAL '1 year';
    
    -- Archiver les transcripts de plus de 90 jours
    UPDATE ultravox_transcripts 
    SET messages = '{"archived": true}'
    WHERE processed_at < NOW() - INTERVAL '90 days'
    AND messages != '{"archived": true}';
    
    RAISE NOTICE 'Nettoyage des anciennes donnÃ©es terminÃ©';
END;
$$ LANGUAGE plpgsql;

-- DonnÃ©es d'exemple pour les tests
INSERT INTO ultravox_stats (total_calls, total_duration, joined_calls, daily_data) 
VALUES 
    (10, '600s', 9, '{"test": true}'),
    (15, '900s', 14, '{"test": true}')
ON CONFLICT DO NOTHING;

COMMIT;
EOF

# CrÃ©er le rÃ©pertoire pour les workflows
mkdir -p workflows

# CrÃ©er le fichier de configuration n8n
log_info "CrÃ©ation du fichier de configuration..."
cat > .env << 'EOF'
# Configuration gÃ©nÃ©rÃ©e automatiquement
N8N_BASIC_AUTH_ACTIVE=true
N8N_BASIC_AUTH_USER=admin
N8N_BASIC_AUTH_PASSWORD=changeme123
N8N_HOST=localhost
N8N_PORT=5678
POSTGRES_HOST=postgres
POSTGRES_PORT=5432
POSTGRES_DB=ultravox_db
POSTGRES_USER=ultravox_user
POSTGRES_PASSWORD=ultravox_password_123
EOF

# Fonction pour demander les credentials
ask_credentials() {
    log_info "Configuration des credentials..."
    
    echo
    read -p "ClÃ© API Ultravox (optionnel pour l'instant): " ULTRAVOX_API_KEY
    read -p "Email administrateur: " ADMIN_EMAIL
    read -p "NumÃ©ro de tÃ©lÃ©phone administrateur: " ADMIN_PHONE
    
    # Ajouter les credentials au fichier .env
    echo "" >> .env
    echo "# Credentials utilisateur" >> .env
    echo "ULTRAVOX_API_KEY=${ULTRAVOX_API_KEY}" >> .env
    echo "ADMIN_EMAIL=${ADMIN_EMAIL}" >> .env
    echo "ADMIN_PHONE=${ADMIN_PHONE}" >> .env
}

# CrÃ©er le script de dÃ©marrage
log_info "CrÃ©ation du script de dÃ©marrage..."
cat > start.sh << 'EOF'
#!/bin/bash

echo "DÃ©marrage des services Ultravox n8n..."

# DÃ©marrer les conteneurs
docker-compose up -d

echo "Attente du dÃ©marrage des services..."
sleep 10

# VÃ©rifier que les services sont en cours d'exÃ©cution
if docker-compose ps | grep -q "Up"; then
    echo "âœ… Services dÃ©marrÃ©s avec succÃ¨s!"
    echo ""
    echo "ðŸŒ Interface n8n: http://localhost:5678"
    echo "ðŸ‘¤ Utilisateur: admin"
    echo "ðŸ”‘ Mot de passe: changeme123"
    echo ""
    echo "ðŸ—„ï¸  Base de donnÃ©es PostgreSQL: localhost:5432"
    echo "ðŸ“Š Base de donnÃ©es: ultravox_db"
    echo ""
    echo "ðŸ“– Documentation: ./instructions-workflow-ultravox.md"
else
    echo "âŒ Erreur lors du dÃ©marrage des services"
    docker-compose logs
fi
EOF

chmod +x start.sh

# CrÃ©er le script d'arrÃªt
cat > stop.sh << 'EOF'
#!/bin/bash

echo "ArrÃªt des services Ultravox n8n..."
docker-compose down

echo "âœ… Services arrÃªtÃ©s"
EOF

chmod +x stop.sh

# CrÃ©er le script de sauvegarde
cat > backup.sh << 'EOF'
#!/bin/bash

BACKUP_DIR="./backups/$(date +%Y%m%d_%H%M%S)"
mkdir -p "$BACKUP_DIR"

echo "CrÃ©ation de la sauvegarde dans $BACKUP_DIR..."

# Sauvegarde des donnÃ©es n8n
docker exec n8n-ultravox tar czf - /home/node/.n8n > "$BACKUP_DIR/n8n_data.tar.gz"

# Sauvegarde de la base de donnÃ©es
docker exec postgres-ultravox pg_dump -U ultravox_user ultravox_db > "$BACKUP_DIR/database.sql"

# Sauvegarde des fichiers de configuration
cp .env "$BACKUP_DIR/"
cp docker-compose.yml "$BACKUP_DIR/"
cp workflow-ultravox-n8n.json "$BACKUP_DIR/"

echo "âœ… Sauvegarde crÃ©Ã©e: $BACKUP_DIR"
EOF

chmod +x backup.sh

# CrÃ©er le script de mise Ã  jour
cat > update.sh << 'EOF'
#!/bin/bash

echo "Mise Ã  jour du workflow Ultravox n8n..."

# Sauvegarder avant mise Ã  jour
./backup.sh

# Mettre Ã  jour les images Docker
docker-compose pull

# RedÃ©marrer les services
docker-compose down
docker-compose up -d

echo "âœ… Mise Ã  jour terminÃ©e"
EOF

chmod +x update.sh

# Menu interactif pour la configuration
echo
log_info "Configuration des credentials (recommandÃ©)..."
echo "1. Configurer maintenant"
echo "2. Configurer plus tard"
read -p "Choisissez une option (1-2): " CONFIG_CHOICE

if [ "$CONFIG_CHOICE" = "1" ]; then
    ask_credentials
else
    log_warning "N'oubliez pas de configurer vos credentials dans le fichier .env"
fi

# Installation terminÃ©e
echo
log_success "Installation terminÃ©e avec succÃ¨s!"
echo
echo "ðŸ“ RÃ©pertoire d'installation: $WORK_DIR"
echo "ðŸš€ Pour dÃ©marrer: ./start.sh"
echo "ðŸ›‘ Pour arrÃªter: ./stop.sh"
echo "ðŸ’¾ Pour sauvegarder: ./backup.sh"
echo "ðŸ”„ Pour mettre Ã  jour: ./update.sh"
echo
echo "ðŸ“– Consultez le fichier 'instructions-workflow-ultravox.md' pour plus de dÃ©tails."
echo

# Proposer de dÃ©marrer immÃ©diatement
echo
read -p "Voulez-vous dÃ©marrer les services maintenant? (y/N): " START_NOW

if [[ "$START_NOW" =~ ^[Yy]$ ]]; then
    log_info "DÃ©marrage des services..."
    ./start.sh
else
    log_info "Vous pouvez dÃ©marrer les services plus tard avec: ./start.sh"
fi

echo
log_success "Installation du workflow Ultravox n8n terminÃ©e!"
echo -e "${BLUE}Merci d'avoir utilisÃ© le script d'installation automatique.${NC}"